{"id":"microvm-orchestrator-mcp-464","title":"Add unit tests for task.py state machine","description":"See test_plan.md § Task State Machine","status":"open","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:24.652843+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:44:24.652843+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-464","depends_on_id":"microvm-orchestrator-mcp-6jq","type":"blocks","created_at":"2026-01-30T10:53:51.89024+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-4bc","title":"Migrate /Users/ture/projects/microvm-orchestrator MCP server to this repo","status":"closed","priority":1,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-26T14:49:25.404094+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:23:45.116138+02:00","closed_at":"2026-01-30T11:23:45.116138+02:00","close_reason":"Closed"}
{"id":"microvm-orchestrator-mcp-5eg","title":"Remove legacy packages config from VM build","description":"See nix_flake_plan.md for architecture overview.\n\n## What to remove\n- projectConfig.packages handling from vm-config.nix\n- configFile argument from default.nix (or repurpose for other settings)\n- extraPackages variable from vm-config.nix\n\n## Files to modify\n- nix/vm-config.nix\n- default.nix","status":"closed","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T11:20:17.489775+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T17:46:15.408136+02:00","closed_at":"2026-01-30T17:46:15.408136+02:00","close_reason":"Removed legacy packages config: projectConfig.packages, extraPackages, configFile argument from Nix files and Python code. Tooling is now provided via user's flake.nix and nix develop."}
{"id":"microvm-orchestrator-mcp-635","title":"Add end-to-end integration tests with real microVM","description":"See test_plan.md § Integration Tests","status":"open","priority":3,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:26.46794+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:44:26.46794+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-635","depends_on_id":"microvm-orchestrator-mcp-yms","type":"blocks","created_at":"2026-01-30T10:53:53.894485+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-635","depends_on_id":"microvm-orchestrator-mcp-pfs","type":"blocks","created_at":"2026-01-30T11:21:31.56072+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-6jq","title":"Set up pytest test infrastructure","description":"See test_plan.md for architecture. Create tests/conftest.py and tests/fixtures/","status":"closed","priority":1,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:24.308726+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:59:33.943682+02:00","closed_at":"2026-01-30T10:59:33.943682+02:00","close_reason":"Created test infrastructure: tests/conftest.py with 15+ fixtures, tests/fixtures/mocks.py with subprocess/PTY helpers, added pytest-asyncio/pytest-cov deps, verified 12 smoke tests pass"}
{"id":"microvm-orchestrator-mcp-7hw","title":"Review async Python code for blocking operations","description":"Audit the codebase to identify any blocking operations in our async Python code that could prevent parallel request handling. Look for:\\n- Synchronous I/O operations\\n- Blocking library calls\\n- CPU-bound operations not offloaded to thread pools\\n- Missing await statements\\n- Any code that could block the event loop","status":"closed","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:32:34.147368+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:11:48.624596+02:00","closed_at":"2026-01-30T11:11:48.624596+02:00","close_reason":"Completed async code review. Fixed critical blocking operations in git.py and vm.py using asyncio.to_thread(). Created follow-up issue microvm-orchestrator-mcp-7xh for remaining low-priority async refactoring."}
{"id":"microvm-orchestrator-mcp-7pb","title":"Add integration tests for tools.py orchestrator","description":"See test_plan.md § Orchestrator","status":"open","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:25.908409+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:44:25.908409+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-7pb","depends_on_id":"microvm-orchestrator-mcp-464","type":"blocks","created_at":"2026-01-30T10:53:53.102371+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-7pb","depends_on_id":"microvm-orchestrator-mcp-uiy","type":"blocks","created_at":"2026-01-30T10:53:53.172899+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-7pb","depends_on_id":"microvm-orchestrator-mcp-vqa","type":"blocks","created_at":"2026-01-30T10:53:53.251238+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-7pb","depends_on_id":"microvm-orchestrator-mcp-pki","type":"blocks","created_at":"2026-01-30T10:53:53.323275+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-7pb","depends_on_id":"microvm-orchestrator-mcp-pfs","type":"blocks","created_at":"2026-01-30T11:21:31.191807+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-7xh","title":"Refactor remaining Orchestrator methods to be async-aware","description":"Make the remaining synchronous Orchestrator methods async-aware to improve consistency and prevent potential blocking issues.\n\n## Background\nThe async code audit (microvm-orchestrator-mcp-7hw) identified that while the critical blocking operations (git setup, nix-build, VM start) have been fixed, there are still some synchronous methods that could benefit from async handling.\n\n## Scope\nMethods to consider making async:\n- `get_task_info()` - calls `Task.load()` and `task.get_result()` which do file I/O\n- `get_task_logs()` - checks file existence\n- `_get_task()` - loads tasks from disk\n- `list_tasks()` - iterates directories and loads tasks\n\n## Approach\n1. Use `asyncio.to_thread()` for file I/O operations\n2. Update server.py to await these methods\n3. Consider using aiofiles for more idiomatic async file I/O\n\n## Notes\n- These operations are generally fast (\u003c10ms) so this is lower priority than the critical fixes\n- The current implementation works but could block briefly during disk I/O\n- This refactor would make the async/sync interface more consistent","status":"open","priority":3,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T11:11:38.336853+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:11:38.336853+02:00"}
{"id":"microvm-orchestrator-mcp-8tf","title":"Add integration test for nix develop environment","description":"See nix_flake_plan.md for architecture overview.\n\n## Implementation\nCreate integration test that:\n1. Sets up repo with flake.nix providing bun\n2. Runs task 'run bun --version and report the output'\n3. Verifies task succeeds and output contains version\n\n## Key test - dynamic dependency addition\nAlso test:\n1. Run task: 'Add cowsay to the flake.nix buildInputs, then run cowsay hello'\n2. Verify Claude modifies flake.nix, runs nix develop, and cowsay works\n3. This proves the writable Nix store and in-VM builds work\n\n## Files to create\n- tests/integration/test_nix_develop.py (or similar)","status":"open","priority":3,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T11:20:26.045754+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:20:26.045754+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-8tf","depends_on_id":"microvm-orchestrator-mcp-pfs","type":"blocks","created_at":"2026-01-30T11:20:39.414124+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-adh","title":"refactor project structure","description":"Codebase should follow best uv project structure practice, we should prepare this project to be something that can be run with uvx","status":"closed","priority":0,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-26T14:52:19.185918+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:41:29.408538+02:00","closed_at":"2026-01-30T11:41:29.408538+02:00","close_reason":"Closed","dependencies":[{"issue_id":"microvm-orchestrator-mcp-adh","depends_on_id":"microvm-orchestrator-mcp-4bc","type":"blocks","created_at":"2026-01-26T14:53:35.384407+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-ca6","title":"Update documentation for flake-based setup","description":"See nix_flake_plan.md for architecture overview.\n\n## Implementation\nUpdate AGENTS.md and/or README.md to:\n- Document that flake.nix is required\n- Provide example flake.nix template\n- Explain how devShells.default works\n- Document the dynamic dependency addition capability\n\n## Files to modify\n- AGENTS.md\n- README.md (if applicable)","status":"open","priority":3,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T11:20:25.69164+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:20:25.69164+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-ca6","depends_on_id":"microvm-orchestrator-mcp-pfs","type":"blocks","created_at":"2026-01-30T11:20:39.054104+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-dr5","title":"Enable Nix flakes experimental features in microVM","description":"See nix_flake_plan.md for architecture overview.\n\n## Implementation\nAdd NixOS configuration to nix/vm-config.nix:\n\n```nix\nnix.settings = {\n  experimental-features = [ \"nix-command\" \"flakes\" ];\n  trusted-users = [ \"root\" \"claude\" ];\n};\n```\n\n## Files to modify\n- nix/vm-config.nix","status":"closed","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T11:20:17.156479+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:42:17.448005+02:00","closed_at":"2026-01-30T11:42:17.448005+02:00","close_reason":"Closed","dependencies":[{"issue_id":"microvm-orchestrator-mcp-dr5","depends_on_id":"microvm-orchestrator-mcp-klc","type":"blocks","created_at":"2026-01-30T11:20:37.6321+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-hcx","title":"Create AGENTS.md to guide agentic AI development","description":"Document what this project is about, and establish that the agent should take the role of a principal engineer that is very careful and thoughtful about changes to the codebase","status":"closed","priority":0,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-26T14:57:08.966865+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:26:36.72853+02:00","closed_at":"2026-01-30T10:26:36.72853+02:00","close_reason":"Created comprehensive AGENTS.md documenting project purpose, architecture, and principal engineer mindset"}
{"id":"microvm-orchestrator-mcp-ibu","title":"Create comprehensive test plan for microvm-orchestrator-mcp","description":"## Overview\n\nCreate a test plan covering all components of the microvm-orchestrator-mcp project. Tests should be:\n- **Atomic**: Each test verifies ONE specific behavior\n- **Fast**: Unit tests mock external dependencies (nix, git, VM processes)\n- **Real**: Integration tests actually spawn microVMs to verify end-to-end functionality\n\n## Components to Test\n\n### 1. Core Modules (Unit Tests)\n\n**Task State Machine** (`core/task.py`)\n- State transitions: PENDING → RUNNING → COMPLETED/FAILED\n- Invalid transitions rejected\n- Thread-safe state updates\n- Task serialization/deserialization (task.json)\n\n**Event Queue** (`core/events.py`)\n- Thread-safe event emission\n- Async waiting with timeouts\n- Multiple waiters receiving same event\n- Cross-thread signaling\n\n**Git Operations** (`core/git.py`)\n- `setup_isolated_repo()`: Creates proper clone with correct remotes\n- `merge_task_commits()`: Fast-forward merge path\n- `merge_task_commits()`: Rebase path when fast-forward fails\n- Conflict detection and preservation at refs/tasks/\u003cid\u003e\n- `cleanup_task_ref()`: Removes refs properly\n- `MergeResult` serialization\n\n**VM Process** (`core/vm.py`)\n- `VMConfig` validation\n- `build_vm()`: nix-build command construction\n- `write_task_files()`: Correct file contents\n- PTY creation and log streaming\n- Exit code capture\n\n### 2. Orchestrator (Integration-ish Tests)\n\n**tools.py - Orchestrator class**\n- Task lifecycle: create → run → complete → cleanup\n- API key retrieval and cleanup\n- Concurrent task handling across slots\n- Error propagation from VM failures\n\n### 3. MCP Tools (Contract Tests)\n\n**server.py - 5 MCP tools**\n- `run_task`: Returns task_id, handles invalid inputs\n- `get_task_info`: Returns correct status and results\n- `get_task_logs`: Returns valid log path\n- `wait_next_event`: Blocks correctly, handles timeouts\n- `cleanup_task`: Removes files, optionally git refs\n\n### 4. Integration Tests (Real MicroVM)\n\n**End-to-end with actual VM**\n- Spawn VM with simple task (e.g., \"create a file called test.txt with 'hello'\")\n- Verify VM completes successfully\n- Verify result.json written correctly\n- Verify git commits merged back\n- Verify cleanup removes all artifacts\n\n**Error scenarios**\n- VM task that fails intentionally\n- VM that times out (if timeout implemented)\n- Merge conflict scenario\n\n## Test Infrastructure Needed\n\n1. pytest fixtures for mocking:\n   - Git repositories (temp dirs with git init)\n   - Nix build process\n   - VM process lifecycle\n\n2. Integration test fixtures:\n   - Real NixOS VM image (may need small test image)\n   - Isolated git repos for merge testing\n\n3. Test utilities:\n   - Async test helpers for event queue\n   - Thread-safe test assertions\n\n## Success Criteria\n\n- All unit tests pass in \u003c 30 seconds\n- Integration tests pass (may take longer for VM boot)\n- Coverage \u003e 80% on core modules\n- Tests are truly atomic (no interdependencies)","status":"closed","priority":1,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:35:19.017448+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:54:09.149539+02:00","closed_at":"2026-01-30T10:54:09.149539+02:00","close_reason":"Decomposed into granular test issues with dependencies"}
{"id":"microvm-orchestrator-mcp-klc","title":"Create writable Nix store disk image for VM","description":"See nix_flake_plan.md for architecture overview.\n\nTOP PRIORITY: This is the foundational change that enables all other flake features.\n\n## Why this is critical\n- Current VM mounts host /nix/store as read-only\n- nix develop needs to write to /nix/store to build packages\n- Claude needs to modify flake.nix and rebuild during development\n\n## Implementation\n1. Create ext4 disk image for Nix store (or use microvm.nix volume support)\n2. Pass nixStoreDir path to VM build (similar to varDir, containerDir)\n3. Mount the disk image at /nix/store (writable)\n4. Configure Nix binary cache (cache.nixos.org) for fast package downloads\n5. Persist the store across tasks (per slot) to avoid re-downloading\n\n## Files to modify\n- nix/vm-config.nix\n- default.nix\n- src/microvm_orchestrator/core/vm.py\n- src/microvm_orchestrator/tools.py\n\n## Sizing\nStart with 20-50GB disk image (Nix store can grow large). Use dedicated disk image per slot for simplicity.","status":"closed","priority":0,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T11:20:16.815818+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:36:01.050981+02:00","closed_at":"2026-01-30T11:36:01.050981+02:00","close_reason":"Implemented writable Nix store with ext4 volume. Made required args fail early."}
{"id":"microvm-orchestrator-mcp-pfs","title":"Run Claude inside nix develop shell","description":"See nix_flake_plan.md for architecture overview.\n\n## Implementation\nModify nix/scripts/run-claude-task.sh wrapper script to:\n1. Require $REPO_DIR/flake.nix to exist (fail with clear error if missing)\n2. Run: nix develop $REPO_DIR --command \u003cclaude-command\u003e\n3. If nix develop fails, fail the task with the error message\n\nThe wrapper becomes:\n```bash\ncd \"$REPO_DIR\"\nexec nix develop . --command @nodejs@/bin/npx -y @anthropic-ai/claude-code@latest ...\n```\n\n## Files to modify\n- nix/scripts/run-claude-task.sh","status":"closed","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T11:20:17.841692+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T17:57:33.152057+02:00","closed_at":"2026-01-30T17:57:33.152057+02:00","close_reason":"Modified run-claude-task.sh to: 1) Check for flake.nix existence, 2) Run Claude via nix develop. Added nix to replaceVars in vm-config.nix.","dependencies":[{"issue_id":"microvm-orchestrator-mcp-pfs","depends_on_id":"microvm-orchestrator-mcp-klc","type":"blocks","created_at":"2026-01-30T11:20:37.990245+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-pfs","depends_on_id":"microvm-orchestrator-mcp-dr5","type":"blocks","created_at":"2026-01-30T11:20:38.356362+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-pfs","depends_on_id":"microvm-orchestrator-mcp-5eg","type":"blocks","created_at":"2026-01-30T11:20:38.695786+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-pki","title":"Add unit tests for vm.py process management","description":"See test_plan.md § VM Process","status":"closed","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:25.624616+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T11:40:01.208852+02:00","closed_at":"2026-01-30T11:40:01.208852+02:00","close_reason":"Added 20 unit tests for vm.py covering build, runner, task files, VMProcess, env, and slots","dependencies":[{"issue_id":"microvm-orchestrator-mcp-pki","depends_on_id":"microvm-orchestrator-mcp-6jq","type":"blocks","created_at":"2026-01-30T10:53:52.848257+02:00","created_by":"Turkka Mannila"},{"issue_id":"microvm-orchestrator-mcp-pki","depends_on_id":"microvm-orchestrator-mcp-klc","type":"blocks","created_at":"2026-01-30T11:21:30.819464+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-uiy","title":"Add unit tests for events.py async queue","description":"See test_plan.md § Event Queue","status":"open","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:24.977791+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:44:24.977791+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-uiy","depends_on_id":"microvm-orchestrator-mcp-6jq","type":"blocks","created_at":"2026-01-30T10:53:52.253801+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-vqa","title":"Add unit tests for git.py operations","description":"See test_plan.md § Git Operations","status":"open","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:25.300249+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:44:25.300249+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-vqa","depends_on_id":"microvm-orchestrator-mcp-6jq","type":"blocks","created_at":"2026-01-30T10:53:52.575485+02:00","created_by":"Turkka Mannila"}]}
{"id":"microvm-orchestrator-mcp-yms","title":"Add contract tests for server.py MCP tools","description":"See test_plan.md § MCP Server","status":"open","priority":2,"issue_type":"task","owner":"turkka.mannila@gmail.com","created_at":"2026-01-30T10:44:26.193922+02:00","created_by":"Turkka Mannila","updated_at":"2026-01-30T10:44:26.193922+02:00","dependencies":[{"issue_id":"microvm-orchestrator-mcp-yms","depends_on_id":"microvm-orchestrator-mcp-7pb","type":"blocks","created_at":"2026-01-30T10:53:53.598857+02:00","created_by":"Turkka Mannila"}]}
